<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Neighborhood Map | London</title>
		<link href='https://fonts.googleapis.com/css?family=Roboto+Slab:300' rel='stylesheet' type='text/css'>
		<link rel="stylesheet" href="css/bootstrap.min.css" />
		<link rel="stylesheet" href="font-awesome-4.6.3/css/font-awesome.min.css">
		<link rel="stylesheet" href="css/main.css" />
	</head>

	<body>

		<nav id="drawer" class="nav col-sm-3">
			<h2 class="nav__header text-center" style="padding-top: 10px;" data-bind="text: city"></h2>
			<form class="nav__filter form-inline">
				<input type="text" class="col-sm-8 nav__filter__input form-control" id="filter" />
				<button type="submit" class="col-sm-4 nav__filter__filter-btn"><i class="fa fa-filter" aria-hidden="true"></i> Filter</button>
			</form>
      <ul class="nav__list" data-bind="foreach: placeList">
        <li class="nav__item" data-bind="text: title"></li>
      </ul>
    </nav>

		<div class="col-sm-9 main" style="height: 100%;">
			<div class="header col-sm-12">
				<button class="menu-btn">
					<i class="fa fa-bars menu-icon" aria-hidden="true"></i>
				</button>
			</div>

			<div id="map" class="col-sm-12"></div>
		</div>

		<!-- Google Maps API and Places library. -->
    <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBNGEZl6rYqobrTonsMhnYhnnxl3rC07bk&libraries=places&callback=initMap"></script>

		<script>
			var map;
			var markers = [];
			var marker;
			function initMap() {
				map = new google.maps.Map(document.getElementById('map'), {
					center: {lat: 51.515083, lng: -0.122462},
					zoom: 13
				});
// NEW NEW START START
				var infowindow = new google.maps.InfoWindow();
				var service = new google.maps.places.PlacesService(map);

				for (var i = 0; i < initialPlaces.length; i++){
					marker = new google.maps.Marker({
						position: {lat: initialPlaces[i].lat, lng: initialPlaces[i].lng},
						title: initialPlaces[i].title,
						id: initialPlaces[i].placeId,
            map: map,
            animation: google.maps.Animation.DROP
					});
					markers.push(marker);
				}

				markers.forEach(function(location){
					service.getDetails({
		        placeId: location.id
	        }, function(place, status) {
          	if (status === google.maps.places.PlacesServiceStatus.OK) {
							google.maps.event.addListener(location, 'click', function() {
	              infowindow.setContent('<div><strong><a href="' + place.website + '" target="_blank">' + place.name + '</a></strong><br>' +
	                place.formatted_address +  '<br />' +
									'Rating: ' + place.rating + ' / 5 <br />' +
									'Phone: ' + place.international_phone_number + '</div>' +
								 	'<div id="foursquare"></div>');
									// console.log(place.geometry.location.lat() + '!!!');
									addFoursquareContent(place.geometry.location);
	              infowindow.open(map, this);
	            });
						}
					});
				});

				function addFoursquareContent(place){
					// var pl = place;
					// console.log(pl + '!');
					$.ajax({
						url: 'https://api.foursquare.com/v2/venues/explore',
						data: {
							client_id: 'GYFRUTH4OUDFVOKB41NKCHW4HRIINZYEWISECOHXIILXMGMV',  // You've found a key! Unfortunately, the key you're looking for is in another castle.
							client_secret: 'H1EAHQSYMIJCB2UIG1YMNH3SSTGLELGS3KBA20BW0AEJ122L',  // Oh man! You've found a secret! Unfortunately, it's not a very good secret.
							v: 20160324,
							m: 'foursquare',
							limit: 5,
							ll: place.lat() + ',' + place.lng(),
							// ll: initialPlaces[4].lat + ',' + initialPlaces[4].lng,  // Search for venue by coordinates.
							venuePhotos: 1,  // Include photos.
							sortByDistance: 1  // Sort results by distance.
						},
						dataType: 'json'
					})
					.done(function(data) {
						if (data.response.groups) {
							for (var group in data.response.groups) {
								// Avoid unintentionally iterating over prototype properties.
								if (data.response.groups.hasOwnProperty(group)) {
									group = data.response.groups[group];

									var $foursquare = $('#foursquare');
									var venueName, venueUrl, venueCategory, venueAddress, venueRating, venuePhoto;
									$foursquare.append('<hr />' + '<strong>Nearby Venues from Foursquare</strong><br />');
									for (var i = 1; i < group.items.length; i++) {
										venueName = group.items[i].venue.name;
										venueUrl = group.items[i].venue.url;
										venueCategory = group.items[i].venue.categories[0].name;
										if (group.items[i].venue.location.address != undefined) {
											venueAddress = group.items[i].venue.location.address;
										} else {
											venueAddress = group.items[i].venue.location.formattedAddress;
										}
									 	venueRating = group.items[i].venue.rating;
										venuePhoto = '<img src="' + group.items[i].venue.photos.groups[0].items[0].prefix + '500x450' +  group.items[i].venue.photos.groups[0].items[0].suffix + '" alt="" />';
										// console.log(group.items[i].venue);
										// console.log(group.items[2].venue.categories[0].shortName);
										console.log(group.items[i].venue.photos.groups[0].items[0]);
										$foursquare.append('<div><h4><a href="' + venueUrl + '" target="_blank">' + venueName + '</a></h4><br />' +
											venueCategory + '<br />' +
											'Address: ' + venueAddress + '<br />' +
											'Rating: ' + venueRating + ' / 10 <br />' +
											venuePhoto +
											'</div>');
									}
								}
							}
						}
					});
				};

				// $.ajax({
				// 	url: 'https://api.foursquare.com/v2/venues/explore',
				// 	data: {
				// 		client_id: 'GYFRUTH4OUDFVOKB41NKCHW4HRIINZYEWISECOHXIILXMGMV',  // You've found a key! Unfortunately, the key you're looking for is in another castle.
				// 		client_secret: 'H1EAHQSYMIJCB2UIG1YMNH3SSTGLELGS3KBA20BW0AEJ122L',  // Oh man! You've found a secret! Unfortunately, it's not a very good secret.
				// 		v: 20160324,
				// 		m: 'foursquare',
				// 		limit: 1,
				// 		ll: initialPlaces[4].lat + ',' + initialPlaces[4].lng,  // Search for venue by coordinates.
				// 		venuePhotos: 1,  // Include photos.
				// 		sortByDistance: 1  // Sort results by distance.
				// 	},
				// 	dataType: 'json'
				// })
				// .done(function(data) {
				// 	if (data.response.groups) {
				// 		for (var group in data.response.groups) {
				// 			// Avoid unintentionally iterating over prototype properties.
				// 			if (data.response.groups.hasOwnProperty(group)) {
				// 				group = data.response.groups[group];
				//
				// 				// for (var i = 0; i < group.items.length; i++) {
				// 					// console.log(group.items[0].venue);
				// 					// $('.foursquare').innerText(group.items[0].venue.name);
				// 					var str = group.items[0].venue.categories[0].shortName;
				// 					console.log(str);
				// 					// infowindow.setContent('<div>' + group.items[0].venue.name + '</div>');
				// 					// info.results.push(group.items[i].venue);
				// 				// }
				// 			}
				// 		}
				// 	}
				// });

			}
// NEW NEW END END

				// initialPlaces.forEach(function(place){
				// 	window.setTimeout(function() {
	      //     markers.push(new google.maps.Marker({
	      //       position: {lat: place.lat, lng: place.lng},
				// 			title: place.title,
	      //       map: map,
	      //       animation: google.maps.Animation.DROP
	      //     }));
	      //   }, i++ * 200);
				// });
			// }
		</script>

		<script src="js/lib/jquery.js"></script>
		<script src="js/lib/knockout-3.2.0.js"></script>
		<!-- <script src="js/info-window.js"></script> -->
		<script src="js/app.js"></script>
	</body>

</html>

<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Neighborhood Map | London</title>
		<link href='https://fonts.googleapis.com/css?family=Roboto+Slab:300' rel='stylesheet' type='text/css'>
		<link rel="stylesheet" href="css/bootstrap.min.css" />
		<link rel="stylesheet" href="font-awesome-4.6.3/css/font-awesome.min.css">
		<link rel="stylesheet" href="css/main.css" />
	</head>

	<body>

		<nav id="drawer" class="nav col-sm-3">
			<h2 class="nav__header text-center" style="padding-top: 10px;" data-bind="text: city"></h2>
			<form class="nav__filter form-inline">
				<input type="text" class="col-sm-8 nav__filter__input form-control" id="filter" />
				<button type="submit" class="col-sm-4 nav__filter__filter-btn"><i class="fa fa-filter" aria-hidden="true"></i> Filter</button>
			</form>
      <ul class="nav__list" data-bind="foreach: placeList">
        <li class="nav__item" data-bind="text: title"></li>
      </ul>
    </nav>

		<div class="col-sm-9 main" style="height: 100%;">
			<div class="header col-sm-12">
				<button class="menu-btn">
					<i class="fa fa-bars menu-icon" aria-hidden="true"></i>
				</button>
			</div>

			<div id="map" class="col-sm-12"></div>
		</div>

		<!-- Google Maps API and Places library. -->
    <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBNGEZl6rYqobrTonsMhnYhnnxl3rC07bk&libraries=places&callback=initMap"></script>

		<script>
			var map, marker;
			var markers = [];
			function initMap() {
				map = new google.maps.Map(document.getElementById('map'), {
					center: {lat: 51.515083, lng: -0.122462},
					zoom: 13
				});

				var infowindow = new google.maps.InfoWindow();
				var service = new google.maps.places.PlacesService(map);

				for (var i = 0; i < initialPlaces.length; i++){
					marker = new google.maps.Marker({
						position: {lat: initialPlaces[i].lat, lng: initialPlaces[i].lng},
						title: initialPlaces[i].title,
						id: initialPlaces[i].placeId,
            map: map,
            animation: google.maps.Animation.DROP
					});
					// marker.addListener('click', bounceMarker);

					markers.push(marker);

					// marker.addListener('click', bounceMarker);
					// console.log(getMarkerById(marker.id).title);
				}

				function getMarkerById(id){
					id = id.toString();
			    for (var i = 0; i < markers.length; i++) {
			      if (markers[i].id === id) {
			        return markers[i];
			      }
			    }
			    // If we made it here, the marker wasn't found.
			    return null;
				}

				function bounceMarker(){
					var duration = 1.5;  // Seconds.
					console.log(marker.id);
    			marker.setAnimation(google.maps.Animation.BOUNCE);

    			window.setTimeout(end, duration * 1000);

			    function end() {
			      marker.setAnimation(null);
			    }
				}

				markers.forEach(function(location){
					service.getDetails({
		        placeId: location.id
	        }, function(place, status) {
          	if (status === google.maps.places.PlacesServiceStatus.OK) {
							google.maps.event.addListener(location, 'click', function() {
	              infowindow.setContent('<div id="venue-info" class="text-center">' +
	                '<h2><a href="' + place.website + '" targer="_blank">' + place.name + '</a></h2>' +
	                '<ul class="google-result-details">' +
	                '<li class="google-result-detail">' + place.formatted_address + '</li>' +
	                '<li class="google-result-detail">' + place.international_phone_number + '</li>' +	                '<li class="google-result-detail">Rating: ' + place.rating + ' / 5 </li>' +
	                '</ul>' +
	                '</div>' +
									'<div id="foursquare" class="text-center"></div>');
									addFoursquareContent(place.geometry.location);
	              infowindow.open(map, this);
	            });
						}
					});
				});

				function addFoursquareContent(place){
					$.ajax({
						url: 'https://api.foursquare.com/v2/venues/explore',
						data: {
							client_id: 'GYFRUTH4OUDFVOKB41NKCHW4HRIINZYEWISECOHXIILXMGMV',  // You've found a key! Unfortunately, the key you're looking for is in another castle.
							client_secret: 'H1EAHQSYMIJCB2UIG1YMNH3SSTGLELGS3KBA20BW0AEJ122L',  // Oh man! You've found a secret! Unfortunately, it's not a very good secret.
							v: 20160324,
							m: 'foursquare',
							limit: 7,
							ll: place.lat() + ',' + place.lng(),
							venuePhotos: 1,  // Include photos.
							sortByDistance: 1  // Sort results by distance.
						},
						dataType: 'json'
					})
					.done(function(data) {
						if (data.response.groups) {
							for (var group in data.response.groups) {
								// Avoid unintentionally iterating over prototype properties.
								if (data.response.groups.hasOwnProperty(group)) {
									group = data.response.groups[group];

									var $foursquare = $('#foursquare');
									var nearVenue, venuePhoto;
									$foursquare.append('<hr /><strong>Nearby Venues from Foursquare</strong>');
									for (var i = 1; i < group.items.length; i++) {
										nearVenue = group.items[i].venue;
										venuePhoto = '<img src="' + nearVenue.photos.groups[0].items[0].prefix + '500x450' +  nearVenue.photos.groups[0].items[0].suffix + '" alt="' + nearVenue.name + '" />';
										// console.log(nearVenue);
										$foursquare.append('<div id="venue-info-foursquare">' +
										'<h2><a href="https://foursquare.com/v/' + nearVenue.id + '?ref=GYFRUTH4OUDFVOKB41NKCHW4HRIINZYEWISECOHXIILXMGMV" target="_blank">' + nearVenue.name + '</a></h2>' +
										'<ul class="foursquare-result-details">' +
		                '<li class="foursquare-result-detail">' + nearVenue.categories[0].name + '</li>' +
		                '<li class="foursquare-result-detail">Address: ' + nearVenue.location.formattedAddress + '</li>' +
										'<li class="foursquare-result-detail">Rating: ' + nearVenue.rating + ' / 10 </li>' +
										'<li class="foursquare-result-detail">Chekins: ' + nearVenue.stats.checkinsCount + '</li>' +
										'<li class="foursquare-result-detail">' + venuePhoto + '</li>' +
		                '</ul>' +
										'</div>');
									}
								}
							}
						}
					});
				};
			}
		</script>

		<script src="js/lib/jquery.js"></script>
		<script src="js/lib/knockout-3.2.0.js"></script>
		<!-- <script src="js/info-window.js"></script> -->
		<script src="js/app.js"></script>
	</body>

</html>
